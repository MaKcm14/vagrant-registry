# Руководство по развертыванию Vagrant-registry
<hr>
<hr>

## Deployment
### Установка сертификата
Для того чтобы сервер мог принимать запросы по протоколу HTTPS, предварительно необходимо задать *private key* и *сертификат сервера* для прокси-сервера Nginx.

Это делается через задание собственного *private key* в файле `./conf/certificate/vagrant.key` и сертификата - `./conf/certificate/vagrant.crt`.

Концептуально весь трафик вне Nginx будет защищенным, в то время как внутри контейнера передача будет открытой.

### Manual
1. Склонируйте репозиторий в папку проекта: `https://github.com/MaKcm14/vagrant-registry.git`
2. `cd vagrant-registry`
3. Сгенерируйте секретный ключ: `export SECRET_KEY=$(LC_ALL=C tr -dc 'A-Za-z0-9!#$%&' </dev/urandom | head -c 50 ; echo)`
4. Создайте папки, в которых будут хранится логи и боксы: `mkdir -p
    {any_path}/var/vr/logs/nginx
    {any_path}/var/vr/logs/supervisord
    {any_path}/var/vr/logs/gunicorn
    {any_path}/var/vr/logs/django
    {any_path}/var/vr/protected_media`
5. Установите клиентские зависимости: `docker image build -t prod-client ./client && docker run -v {any_absolute_path}/vagrant-registry/client:/project prod-client yarn --frozen-lockfile`
6. Соберите клиентскую часть реестра: `docker run -v {any_absolute_path}/vagrant-registry/client:/project prod-client yarn build`
7. Соберите основной образ реестра: `docker image build -t vagrant-registry .`
8. Запустите контейнер: `docker container run
    -d
    -e SECRET_KEY
    -v {any_absolute_path}/var/vr/logs/:/logs
    -v {any_absolute_path}/var/vr/protected_media/:/code/api/protected_media
    -v vagrant-registry-db:/var/lib/postgresql
    -p 443:443
    --name vagrant-registry vagrant-registry`
9. Создайте учетную запись администратора: `docker exec -it vagrant-registry python3 /code/api/manage.py createsuperuser`
<hr>

## Usage

### Авторизация
После шага Deployment будет запущен контейнер, принимающий запросы на 443 порт по протоколу HTTPS.

Чтобы войти в учетную запись, необходимо перейти по следующему url: `http://{any_ip}/`, где any_ip - IP-адрес любого интерфейса машины, и затем авторизоваться через форму `Sign In`.
<hr>

### Просмотр боксов
Во вкладке `Vagrant Registry` указываются все боксы, добавленные текущей учетной записью, от имени которой производится работа в реестре в данный момент.

В реестре все репозитории делятся на private и public. Первые доступны только для создателей, вторые - всем.

Во вкладке `Boxes` указываются все публичные образы реестра. Также можно осуществлять поиск по репозиториям реестра.
<hr>

### Загрузка бокса в реестр
Чтобы загрузить бокс, необходимо создать для него репозиторий, если это еще не было сделано. Для этого используется `New Box`.

В рамках одного репозитория можно создавать разделение боксов по версиям. В рамках одной версии можно загружать боксы для нескольких провайдеров.

Помимо этого, есть возможность загружать боксы не через веб-версию регистра, а через CLI. Для этого необходимо установить *vagrant-registry-plugin* в vagrant:
1. `git clone https://github.com/MaKcm14/vagrant-registry-plugin.git`
2. `cd vagrant-registry-plugin`
3. `bundle exec rake build`
4. `cd pkg`
5. `vagrant plugin install ./vagrant-registry-0.1.0.gem` // данную операцию нужно производить с включенным прокси или VPN, так как hashicorp.com блокируют всякие обращения с российских IP.

Для удаления плагина используется:
`vagrant plugin uninstall <имя плагина в vagrant>`

Данный плагин будет требовать авторизации при попытке скачать или загрузить бокс. Авторизация потребуется для любой работы с private-репозиториями и для загрузки боксов в public-репозитории. Поэтому если при попытке скачать или загрузить бокс возникает ошибка `You are not logged in`, ошибка `401` или `404` (если Вы не авторизованы), то:

- для авторизации необходимо выполнить `vagrant registry login http://{any_ip}`

После этого для загрузки бокса от имени вашей учетной записи необходимо выполнить: `vagrant registry push <путь_к_боксу> http://{any_ip}/<имя_учетной_записи>/<название_репозитория> <версия> <наименование_провайдера>`

Данная команда также позволяет создать репозиторий, если его до этого не существовало. При этом по умолчанию репозиторий создается как private.

<hr>

### Установка бокса из реестра
Для установки бокса в локальное хранилище vagrant используется `vagrant box add <имя_учетной_записи>/<наименование_репо> http://{any_ip}/<имя_учетной_записи>/<имя_репо>`

Аналогично можно производить установку и через `vagrant init`.
При создании репозитория на его странице будет указана часть `Quick Start`, которая покажет, как можно установить и запустить бокс из текущего репозитория.
<hr>

### Администрирование
Реестр имеет админ-панель. Для её открытия необходимо перейти к `Admin` вкладке, нажав на имя учетной записи справа в верхнем углу.

После авторизации можно будет получить доступ ко всем пользователем реестра, их репозиториям, токенам и пр.
<hr>

## P.S.
*Оригинальный репозиторий реестра*: `https://github.com/polart/vagrant-registry`

*Оригинальный репозиторий плагина*: `https://github.com/polart/vagrant-registry-plugin`

*Доработанный репозиторий реестра* (добавлена возможность работы с архитектурами): `https://github.com/MaKcm14/vagrant-registry.git`

*Доработанный репозиторий плагина* (исправлена необходимость в аутентификации при установке бокса из публичного репозитория, а также добавлена возможность загружать боксы с указанием архитектур): `https://github.com/MaKcm14/vagrant-registry-plugin.git` 
